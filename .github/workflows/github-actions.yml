
name: Github Drowned Moses
on: push
jobs:
  # Update-moses:
  #   runs-on: ubuntu-latest
  #   steps:
  #     -
  #       name: Checkout repo
  #       uses: actions/checkout@v2
  #     -
  #       name: Build Moses container and push
  #       run: |
  #         cd ${{ github.workspace }}
  #         cat README.md
  #         docker build -f Dockerfile -t ${{ secrets.DOCKERHUB_USERNAME }}/moses .
  #         docker login --username=${{ secrets.DOCKERHUB_USERNAME }} --password=${{ secrets.DOCKERHUB_PASSWORD }}
  #         docker push ${{ secrets.DOCKERHUB_USERNAME }}/moses
# if you want to access the repo
  # container:
  #     image: matheuscastello/moses
  #     options: --user root
# cd /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}/
  Build-app:
    # needs: Update-moses
    timeout-minutes: 360
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@v2
      - 
        name: Moses up and run
        run: |
          cd ${{ github.workspace }}/moses-linux
          ./moses &
          export PATH="${{ github.workspace }}/moses-linux:$PATH"
          sleep 15
          cd ${{ github.workspace }}/drowned-moses
          tdskt platforms
          tdskt eula nxp-la-opt-v5 setprop accepted true
          tdskt platforms
          tdskt -p enableemulation
          APPID=$(tdskt load ./appconfig_0/)
          tdskt -p application $APPID runsdk release
          docker run --rm -t \
            -v ${PWD}:/app \
            -e QMAKE_DESTIDIR='/app/appconfig_0/work/drowned-moses' \
            drowned-moses_arm64v8-qt5-vivante-no-ssh_bullseye_release_${APPID}_sdk_image \
            bash -c "cd /app && make"
          ls ./appconfig_0/work/drowned-moses
          tdskt -p application $APPID build release
          docker login --username=${{ secrets.DOCKERHUB_USERNAME }} --password=${{ secrets.DOCKERHUB_PASSWORD }}
          docker tag \
            drowned-moses_arm64v8-qt5-vivante-no-ssh_bullseye_release_${APPID}:latest \
            ${{ secrets.DOCKERHUB_USERNAME }}/drowned-moses:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/drowned-moses:latest
